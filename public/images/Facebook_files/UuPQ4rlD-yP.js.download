;/*FB_PKG_DELIM*/

__d("LSMarkOptimisticMessageFailedStoredProcedure",["LSMarkOptimisticMessageFailed","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){var d=[];d[0]=b.optimisticMid;d[1]=b.errorMessage;return c("LSMarkOptimisticMessageFailed").apply(void 0,d.concat([a]))}g["default"]=a}),98);
__d("MAWCreateOptimisticSecureMessage",["I64","LSAuthorityLevel","LSIntEnum","LSMessageReplySourceType","LSMessageReplySourceTypeV2","LSMessageSendStatus","LSQuickReplyType","LSReplyMessageAttachmentType","LSReplyMessageStatus","MAWBridgeBuildMsg","MAWMsgReplySnippet","MessagingAttachmentType","QPLUserFlow","ReQL","asyncToGeneratorRuntime","gkx","isMWBumpMessage","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a,b,c,d){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){if(e==null)return[void 0,void 0];var g=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.messages).getKeyRange(b,e.timestampMs,e.messageId)));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"get_reply_msg_end",{instanceKey:f});a=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.attachments).getKeyRange(b,e.messageId)));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"get_reply_attachment_end",{instanceKey:f});return[g,a]});return k.apply(this,arguments)}function l(a,b){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.contacts).getKeyRange(b)));return a==null?void 0:a.firstName});return m.apply(this,arguments)}function n(a,b,c){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){if(b==null)return;var f=c("isMWBumpMessage")(b)&&b.replyToUserId!=null?b.replyToUserId:b.senderId;a=(yield l(a,f));return(b=d("MAWMsgReplySnippet").buildLocalizedReplySnippet({isAuthorMe:!0,isDeletedMsg:b.replyStatus===c("LSReplyMessageStatus").DELETED,recipientName:a,replySenderIsMe:(h||(h=d("I64"))).equal(f,e)}))==null?void 0:b.toString()});return o.apply(this,arguments)}function p(a){if(a==null)return;var b=a.attachmentType;return(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").IMAGE))||(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").STICKER))?a.previewUrl:void 0}function q(a){if(a!=null){if((h||(h=d("I64"))).equal(a==null?void 0:a.attachmentType,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").IMAGE)))return(i||(i=d("LSIntEnum"))).ofNumber(c("LSReplyMessageAttachmentType").PHOTO);if((h||(h=d("I64"))).equal(a==null?void 0:a.attachmentType,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").STICKER)))return(i||(i=d("LSIntEnum"))).ofNumber(c("LSReplyMessageAttachmentType").STICKER);if((h||(h=d("I64"))).equal(a==null?void 0:a.attachmentType,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").VIDEO)))return(i||(i=d("LSIntEnum"))).ofNumber(c("LSReplyMessageAttachmentType").VIDEO);return(h||(h=d("I64"))).equal(a==null?void 0:a.attachmentType,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").ANIMATED_IMAGE))?(i||(i=d("LSIntEnum"))).ofNumber(c("LSReplyMessageAttachmentType").GIF):(i||(i=d("LSIntEnum"))).ofNumber(c("LSReplyMessageAttachmentType").OTHER)}}function a(a,b,c,d,e,f,g,h,i,j,k,l,m){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,k,l,m,o,r,s,t){b=(yield j(b,h,f,l));l=b[0];b=b[1];g=(yield d("MAWBridgeBuildMsg").buildOptimisticMessage(g,l,m));m=(yield n(a,l,e));a=babelHelpers["extends"]({},g,{authorityLevel:(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),displayedContentTypes:i.ofNumber(s),hasQuickReplies:!1,hotEmojiSize:k,isAdminMessage:!1,isCollapsed:!1,isUnsent:!1,messageId:o,offlineThreadingId:c("gkx")("23990")&&t!=null?t:o,primarySortKey:r,quickReplyType:i.ofNumber(c("LSQuickReplyType").NONE),replyAttachmentType:q(b),replyMediaPreviewHeight:b==null?void 0:b.previewHeight,replyMediaPreviewWidth:b==null?void 0:b.previewWidth,replyMediaUrl:p(b),replyMediaUrlMimeType:b==null?void 0:b.playableUrlMimeType,replySnippet:m,replySourceId:f==null?void 0:f.messageId,replySourceType:f!=null?(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessageReplySourceType").MESSAGE):void 0,replySourceTypeV2:f!=null?(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessageReplySourceTypeV2").MESSAGE):void 0,senderId:e,sendStatus:i.ofNumber(c("LSMessageSendStatus").SENDING_TO_SERVER),sendStatusV2:i.ofNumber(1),textHasLinks:!1,threadKey:h,timestampMs:r,transportKey:"WhatsApp",viewFlags:i.ofNumber(0)});return a});return r.apply(this,arguments)}g.createOptimisticMessageTxn=a}),98);
__d("MAWFetchExternalAttachmentBlob",["asyncToGeneratorRuntime","sendToSentQPLLogger"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield window.fetch(a,{}).then(function(a){return a.blob()})["catch"](function(a){d("sendToSentQPLLogger").markSendToSentPoint(b,"fetch_external_attachment_failed");throw a}));return a});return h.apply(this,arguments)}g.fetchExternalAttachmentBlob=a}),98);
__d("MAWMiActMaybeCreateActThread",["FBLogger","I64","LSAuthorityLevel","LSFactory","LSIntEnum","LSMessagingThreadTypeUtil","LSVerifyE2EEMetadataThreadExistsV2StoredProcedure","MAWCreateGroupThread","MAWCreateOneToOneThread","MAWMiActCreateThreadInActWithMiData","MAWMiActGetThreadLifecycleState","MAWMiActThreadLifecycleState","WAJids","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Duplicated thread creation for ",""]);j=function(){return a};return a}function k(a,b){return a.runInTransaction(function(a){return c("LSVerifyE2EEMetadataThreadExistsV2StoredProcedure")(c("LSFactory")(a),{authorityLevel:(h||(h=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE),threadKey:b,threadType:h.ofNumber(15)}).then(function(){})},"readwrite",void 0,void 0,f.id+":43")}function l(a,b,e){var f=e.actorId;e=e.participantIds;var g=e.filter(function(a){return a!==(i||(i=d("I64"))).to_string(f)});if(d("LSMessagingThreadTypeUtil").isOneToOne(b.threadType)&&g.length===1){var j=g.length===1?g:e;return d("MAWCreateOneToOneThread").call(a,(i||(i=d("I64"))).of_string(j[0]),i.to_string(b.threadKey),"maybeCreateActThread")}else if(d("LSMessagingThreadTypeUtil").isGroup(b.threadType)&&g.length>1)return c("MAWCreateGroupThread")({db:a,offlineThreadingId:b.threadKey,participantIds:e});throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("[MiActMapping] Did not know which type of optimistic thread to create for\n    threadKey: %s, participantsCount: %s, threadType: %s",(i||(i=d("I64"))).to_string(b.threadKey),e.length,(h||(h=d("LSIntEnum"))).toNumber(b.threadType))}function m(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("MAWMiActCreateThreadInActWithMiData").miActCreateThreadInActWithMiData(a.serverThreadKey,a.jidInt64,a.thread.lastActivityTimestampMs,a.thread.lastReadWatermarkTimestampMs,d("LSMessagingThreadTypeUtil").isGroup(a.thread.threadType)));return{chatId:a.chatId,created:a.isCreated,jid:a.chatJid}});return n.apply(this,arguments)}function o(a,b){if(!d("LSMessagingThreadTypeUtil").isOneToOne(a.thread.threadType))return null;var c=b.actorId;b=b.participantIds;b=b.filter(function(a){return a!==(i||(i=d("I64"))).to_string(c)});if(b.length!==1)return null;b=b[0];return{jid:d("WAJids").unsafeCoerceToChatJid(b+"@msgr"),jidInt64:(i||(i=d("I64"))).of_string(b),serverThreadKey:a.thread.threadKey,thread:a.thread,type:"AUTHORITATIVE_THREAD_ONLY"}}var p=new Map(),q=new Set();function a(a,b,c){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=(yield d("MAWMiActGetThreadLifecycleState").getThreadLifecycleStateByThreadKey(a.tables,b,"maybeCreateActThread"));switch(f.type){case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.ACT_THREAD_ONLY:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.THREAD_KEY_ONLY:yield k(a,b);throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("[MiActMapping] We did not call MiActLoadExistingThread for threadKey: %s, threadState: %s",(i||(i=d("I64"))).to_string(b),f.type);case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.AUTHORITATIVE_THREAD_MISSING_MAPPING_ROW:var g=o(f,e);if(g!=null){q.has(g.jid)&&d("WATagsLogger").TAGS(["occamadillo","retry_create_thread"]).LOG(j(),g.jid);q.add(g.jid);return m(g)}else throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("[MiActMapping] MI inserted the thread but the mapping row was not\n        written or it was deleted for threadKey: %s",(i||(i=d("I64"))).to_string(b));case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.OPTIMISTIC_THREAD_NO_ACT:g=(i||(i=d("I64"))).to_string(b);var h=p.get(g);if(h!=null)return h;h=l(a,f.thread,e);p.set(g,h);return h;case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.CLIENT_PARTIAL_MI_THREAD_WITH_ACT:yield k(a,b);return{chatId:f.chatId,created:!1,jid:f.jid};case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.OPTIMISTIC_THREAD_WITH_ACT:return{chatId:f.chatId,created:!1,jid:f.jid};case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.AUTHORITATIVE_THREAD_ONLY:return m(f);case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.MI_AND_ACT_THREAD_COMPLETE:return{chatId:f.chatId,created:!1,jid:f.jid};case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.CLIENT_PARTIAL_MI_THREAD:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.SERVER_PARTIAL_MI_THREAD:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MI_THREAD:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MAPPING_ROW:throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("[MiActMapping] Unhandled ACT thread creation state %s for threadKey:\n        %s",f.type,(i||(i=d("I64"))).to_string(b));default:f.type;throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("[MiActMapping] Unreachable miActThreadState.type: %s",f.type)}});return r.apply(this,arguments)}g["default"]=a}),98);
__d("MAWOptimisticMessageUtils",["MAWBridgeSendAndReceive","Promise","asyncToGeneratorRuntime","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("qex")._("244")===!0){var a=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getWATime"));return a.millisTime}else return(h||(h=b("Promise"))).resolve(Date.now())});return i.apply(this,arguments)}g.getOptimisticMessageTimestamp=a}),98);
__d("MAWSecureAttachmentGroupingUtils",["I64","LSIntEnum","MessagingAttachmentType","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){a=a.reduce(function(a,b){(h||(h=d("I64"))).equal(b.attachmentType,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").IMAGE))?a.mediaStagingsImage.push(b):a.mediaStagingsOther.push(b);return a},{mediaStagingsImage:[],mediaStagingsOther:[]});var b=a.mediaStagingsImage;a=a.mediaStagingsOther;return[].concat(b,a)}function b(a){var b=new Map();a=a.filter(function(a){var b=a[0];a[1];return b.type==="image"});var d=a.length;if(d>1){var e=c("uuidv4")();a.forEach(function(a,c){a[0];a=a[1];b.set(a,{groupId:e,groupIndex:c,groupSize:d})})}return b}g.orderMediaStagingsForGrouping=a;g.generateMediaGroupMetadataForAttachments=b}),98);
__d("MAWPrepareAttachmentsFromMediaManager",["MAWExternalId","MAWMediaManagerUtils","MAWSecureAttachmentGroupingUtils","WAStanzaUtils","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){var f;c("qex")._("536")===!0?f=d("MAWSecureAttachmentGroupingUtils").orderMediaStagingsForGrouping(a):f=a;return h(f,b,e,d("MAWMediaManagerUtils").MAWMediaManagerAttachments)}function h(a,b,c,e){var f=b.hasFile,g=b.hasImage;b=b.hasVideo;var h=null;if(b||g||f){b=a[a.length-1];h=d("WAStanzaUtils").toStanzaId(b.offlineAttachmentId)}else h=d("MAWExternalId").generateExternalId();c(h);g=a.reduce(function(a,b){var c=e.get(b.offlineAttachmentId);c!=null&&a.push([c,d("WAStanzaUtils").toStanzaId(b.offlineAttachmentId)]);return a},[]);return{attachmentOfflineId:h,attachments:g}}g.prepareAttachmentsFromMediaManager_DEPRECATED=a;g.prepareAttachmentsFromMediaManagerImpl=h}),98);
__d("MAWSendExternalLinkXMAV2",["ConstUriUtils","MAWExternalId","MAWExternalLinkUtil","MAWGetEphemeralSettings","MAWGetImageSpec","MAWJobDefinitions","MAWTimedJob","QPLUserFlow","WAArmadilloXMA.pb","WAJobOrchestratorTypes","WALogger","asyncToGeneratorRuntime","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(['S410301 The externalLinkUrl set as native and action URL in XMA is not a valid URI"']);h=function(){return a};return a}function a(a,b,c,d,e,f,g,h,j,k,l){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,i,j,k,l,m,n){k=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(g,k));var o=void 0;if(e!=null&&d("MAWExternalLinkUtil").allowedPreviewTypes.includes(e.type)){e=new File([e],"preview",{type:e.type});var p=(yield d("MAWGetImageSpec").getImageSpec(e));o={file:e,height:p.height,width:p.width}}e={content:a,ephemeralSetting:k==null?void 0:k,offlineAttachmentId:l==null?void 0:l,optimisticMsg:n==null?void 0:{msgId:n==null?void 0:n.offlineMsgId,ts:n==null?void 0:n.offlineMsgTimestamp},quote:m,s2sInstanceKey:i,s2sUserFlowQPLEvent:c("qpl")._(25313175,"1551"),source:j,xmaMessageType:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE};a=(p=d("ConstUriUtils").getUri(f))==null?void 0:p.getDomain();d("ConstUriUtils").isValidUri(f)||d("WALogger").ERROR(h());k={defaultCTA:{actionUrl:f,buttonType:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:f},overlayIconGlyph:void 0,subtitleText:b==null?void 0:b.author_name,titleText:b==null?a:b.title};c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"sending_message_to_wajob",{instanceKey:i});return d("MAWTimedJob").TimedUIJobStarters.waitUntilCompleted(d("MAWJobDefinitions").createStartJobInfo("sendXMAShareMsg",{args:e,chatJid:g,previewFile:(l=o)!=null?l:void 0,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},xmaArgs:k,xmaMsgExternalId:(m=n==null?void 0:n.externalId)!=null?m:d("MAWExternalId").generateExternalId()}))});return i.apply(this,arguments)}g.sendExternalLinkXMAV2=a}),98);
__d("MAWSendExternalLinkXMA_DEPRECATED",["ConstUriUtils","MAWExternalId","MAWExternalLinkUtil","MAWGetEphemeralSettings","MAWGetImageSpec","MAWJobDefinitions","MAWTimedJob","QPLUserFlow","WAArmadilloXMA.pb","WAJobOrchestratorTypes","WALogger","asyncToGeneratorRuntime","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(['S410301 The externalLinkUrl set as native and action URL in XMA is not a valid URI"']);h=function(){return a};return a}function a(a,b,c,d,e,f,g,h,j){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,i,j,k,l){var m=(yield d("MAWExternalLinkUtil").getImageBlobResponse(b==null?void 0:b.thumbnail_url));j=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(f,j));var n=void 0;if(m!=null&&d("MAWExternalLinkUtil").allowedPreviewTypes.includes(m.type)){m=new File([m],"preview",{type:m.type});var o=(yield d("MAWGetImageSpec").getImageSpec_DEPRECATED(m));n={file:m,height:o.height,width:o.width}}m={content:a,ephemeralSetting:j==null?void 0:j,offlineAttachmentId:k==null?void 0:k,quote:l,s2sInstanceKey:g,s2sUserFlowQPLEvent:c("qpl")._(25313175,"1551"),source:i,xmaMessageType:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE};a=(o=d("ConstUriUtils").getUri(e))==null?void 0:o.getDomain();d("ConstUriUtils").isValidUri(e)||d("WALogger").ERROR(h());j={defaultCTA:{actionUrl:e,buttonType:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:e},overlayIconGlyph:void 0,subtitleText:b==null?void 0:b.author_name,titleText:b==null?a:b.title};c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"sending_message_to_wajob",{instanceKey:g});return d("MAWTimedJob").TimedUIJobStarters.waitUntilCompleted(d("MAWJobDefinitions").createStartJobInfo("sendXMAShareMsg",{args:m,chatJid:f,previewFile:(k=n)!=null?k:void 0,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},xmaArgs:j,xmaMsgExternalId:d("MAWExternalId").generateExternalId()}))});return i.apply(this,arguments)}g.sendExternalLinkXMA_DEPRECATED=a}),98);
__d("MAWSendSecureAttachment",["FBLogger","I64","MAWBridgeSendAndReceive","MAWDbMsg","MAWJobDefinitions","MAWUIJob","MAWUIThreadCache","QPLUserFlow","WAJobOrchestratorTypes","asyncToGeneratorRuntime","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("MWLogSend").__setRef("MAWSendSecureAttachment");function a(a,b,c,d,e,f,g,h,i,k,l,m,n,o,p,q){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,j,k,l,m,n,o,p,q,r,s,t){b=(yield d("MAWUIThreadCache").getThreadJidByChatId({threadId:b}));if(b==null){c("QPLUserFlow").endFailure(c("qpl")._(25313175,"1551"),"no_chat_jid",{instanceKey:o});return}var u=null;if(m!=null){m=d("MAWDbMsg").toMsgId(m.messageId);m!=null&&(u=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:m})))}c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"sending_media_to_wajob",{instanceKey:o});switch(j.type){case"image":case"animated_image":case"sticker":var v;m=j.imageSpec;var w=j.thumbnailUrlAndSpec;yield d("MAWUIJob").UIJobStarters.waitUntilCompleted(d("MAWJobDefinitions").createStartJobInfo("sendMediaMsg",{args:{ephemeralSetting:(v=p)!=null?v:void 0,height:m.height,initiatingSource:q,isFirstMsg:n,isForwarded:!1,jpegThumbnail:w.jpegThumbnail,jpegThumbnailHeight:w.height,jpegThumbnailWidth:w.width,mediaGroupMetadata:t,offlineAttachmentId:k,optimisticMsg:r,quote:(v=u)!=null?v:void 0,s2sInstanceKey:o,source:l,width:m.width},attachmentType:"image",chatJid:b,externalId:s,file:j.file,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION}}));break;case"video":w=j.thumbnailUrlAndSpec;yield d("MAWUIJob").UIJobStarters.waitUntilCompleted(d("MAWJobDefinitions").createStartJobInfo("sendMediaMsg",{args:{duration:w.duration,ephemeralSetting:(t=p)!=null?t:void 0,height:w.height,initiatingSource:q,isFirstMsg:n,isForwarded:!1,jpegThumbnail:w.jpegThumbnail,jpegThumbnailHeight:w.height,jpegThumbnailWidth:w.width,offlineAttachmentId:k,optimisticMsg:r,quote:(v=u)!=null?v:void 0,s2sInstanceKey:o,source:l,width:w.width},attachmentType:"video",chatJid:b,externalId:s,file:j.file,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION}}));break;case"audio":m=j.durations;t=j.isPtt;yield d("MAWUIJob").UIJobStarters.waitUntilCompleted(d("MAWJobDefinitions").createStartJobInfo("sendMediaMsg",{args:{duration:Math.round(m),ephemeralSetting:(v=p)!=null?v:void 0,initiatingSource:q,isFirstMsg:n,isForwarded:!1,isPtt:t,offlineAttachmentId:k,optimisticMsg:r,quote:(w=u)!=null?w:void 0,s2sInstanceKey:o,source:l},attachmentType:"audio",chatJid:b,externalId:s,file:j.file,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION}}));break;case"document":m=j.filename;yield d("MAWUIJob").UIJobStarters.waitUntilCompleted(d("MAWJobDefinitions").createStartJobInfo("sendMediaMsg",{args:{ephemeralSetting:(v=p)!=null?v:void 0,filename:m,initiatingSource:q,isFirstMsg:n,isForwarded:!1,offlineAttachmentId:k,optimisticMsg:r,quote:(t=u)!=null?t:void 0,s2sInstanceKey:o,source:l},attachmentType:"application",chatJid:b,externalId:s,file:j.file,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION}}));break;default:c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"uknown_file_type_sendMediaMsg_not_fired",{instanceKey:o}),c("FBLogger")("messenger_web_media").addMetadata("MESSENGER_E2EE_WEB","ERROR_MESSAGE","failed while sending attachment").mustfix("sendSecureAttachment: Failed while sending attachment, unknown attachment type %s",j.type)}var x;switch(j.type){case"image":x=8;break;case"video":x=10;break;case"audio":x=11;break;case"document":x=34;break}i.onReady(function(b){var c=(h||(h=d("I64"))).to_string(e);return b.log(a,{actor:g,attachmentFbids:[],attachmentType:x,backend:1,hasReply:!1,messagingThreadId:c,offlineThreadingId:k,sendType:0,source:l,threadKey:e,threadType:f})});return b});return j.apply(this,arguments)}g.sendSecureAttachment=a}),98);
__d("MAWSendFileMsgIfNecessaryV2",["FBLogger","MAWExternalId","MAWSecureAttachmentGroupingUtils","MAWSendSecureAttachment","Promise","asyncToGeneratorRuntime","qex","sendToSentQPLLogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var f=e.actorId,g=e.attachments,i=e.ephemeralSetting,j=e.initiatingSource,k=e.isFirstMsg,l=e.offlineAttachmentIdToMessageData,m=e.reply,n=e.s2sInstanceKey,o=e.source,p=e.thread,q=e.threadId;d("sendToSentQPLLogger").markSendToSentPoint(n,"prepare_attachment_promises");var r=null;c("qex")._("536")===!0&&(r=d("MAWSecureAttachmentGroupingUtils").generateMediaGroupMetadataForAttachments(g));e=g.map(function(b){var c=b[0];b=b[1];var e=l==null?void 0:l.get(b);return d("MAWSendSecureAttachment").sendSecureAttachment(a,q,p.threadKey,p.threadType,f,c,b,o,m,k,n,i,j,e==null?void 0:{msgId:e==null?void 0:e.offlineMsgId,ts:e==null?void 0:e.offlineMsgTimestamp},(c=e==null?void 0:e.externalId)!=null?c:d("MAWExternalId").generateExternalId(),(e=r)==null?void 0:e.get(b))});yield (h||(h=b("Promise"))).all(e)["catch"](function(a){d("sendToSentQPLLogger").markSendToSentPoint(n,"send_attachment_promise_failed"),d("sendToSentQPLLogger").markSendToSentFail(n,a),a instanceof Error?c("FBLogger")("messenger_web_media").catching(a).addMetadata("MESSENGER_E2EE_WEB","ERROR_MESSAGE","failed while sending attachment promise").mustfix("Failed while sending message"):c("FBLogger")("messenger_web_media").addMetadata("MESSENGER_E2EE_WEB","ERROR_MESSAGE","failed while sending attachment promise").mustfix("Failed while sending attachment, %s",a.message)})});return i.apply(this,arguments)}g.sendFileMsgIfNecessaryV2=a}),98);
__d("MAWSendFileMsgIfNecessary_DEPRECATED",["FBLogger","MAWExternalId","MAWImagePreProcess","MAWSecureAttachmentGroupingUtils","MAWSendSecureAttachment","Promise","asyncToGeneratorRuntime","qex","sendToSentQPLLogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var f=e.actorId,g=e.attachmentOfflineId,i=e.attachments,j=e.ephemeralSetting,k=e.externalAttachmentUrl,l=e.initiatingSource,m=e.isFirstMsg,n=e.offlineAttachmentIdToMessageData,o=e.reply,p=e.s2sInstanceKey,q=e.source,r=e.stickerId,s=e.thread,t=e.threadId;e=e.voiceClip;var u=[];if(e!=null){e={durations:e.duration||0,file:e.file,isPtt:!0,type:"audio"};u.push([e,g])}if(k!=null){e=(yield window.fetch(k,{cache:"no-cache"}).then(function(a){return a.blob()})["catch"](function(a){d("sendToSentQPLLogger").markSendToSentPoint(p,"fetch_external_attachment_failed");throw a}));k=r!=null;r=(yield d("MAWImagePreProcess").imagePreprocess(new File([e],"stickerFromPicker",{type:e.type}),k));u.push([r,g])}u=u.concat(i);d("sendToSentQPLLogger").markSendToSentPoint(p,"prepare_attachment_promises");var v=null;c("qex")._("536")===!0&&(v=d("MAWSecureAttachmentGroupingUtils").generateMediaGroupMetadataForAttachments(u));e=u.map(function(b){var c=b[0];b=b[1];var e=n==null?void 0:n.get(b);return d("MAWSendSecureAttachment").sendSecureAttachment(a,t,s.threadKey,s.threadType,f,c,b,q,o,m,p,j,l,e==null?void 0:{msgId:e==null?void 0:e.offlineMsgId,ts:e==null?void 0:e.offlineMsgTimestamp},(c=e==null?void 0:e.externalId)!=null?c:d("MAWExternalId").generateExternalId(),(e=v)==null?void 0:e.get(b))});yield (h||(h=b("Promise"))).all(e)["catch"](function(a){d("sendToSentQPLLogger").markSendToSentPoint(p,"send_attachment_promise_failed"),d("sendToSentQPLLogger").markSendToSentFail(p,a),a instanceof Error?c("FBLogger")("messenger_web_media").catching(a).addMetadata("MESSENGER_E2EE_WEB","ERROR_MESSAGE","failed while sending attachment promise").mustfix("Failed while sending message"):c("FBLogger")("messenger_web_media").addMetadata("MESSENGER_E2EE_WEB","ERROR_MESSAGE","failed while sending attachment promise").mustfix("Failed while sending attachment, %s",a.message)})});return i.apply(this,arguments)}g.sendFileMsgIfNecessary_DEPRECATED=a}),98);
__d("useLSMessagingInitiatingSourceNumber",["LSMessagingInitiatingSource","MWLSThreadDisplayContext"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=d("MWLSThreadDisplayContext").useMWLSThreadDisplayContext();if(a==null)return;else if(a==="Inbox")return c("LSMessagingInitiatingSource").FACEBOOK_INBOX;else if(a==="FullscreenChat")return c("LSMessagingInitiatingSource").FACEBOOK_FULLSCREEN;else if(a==="ChatTab")return c("LSMessagingInitiatingSource").FACEBOOK_CHAT;else return c("LSMessagingInitiatingSource").ROOMS_SIDE_CHAT}g["default"]=a}),98);
__d("useMAWCreateOptimisticSecureMessageV2",["I64","LSHotEmojiSize","LSIntEnum","MAWAdminMsg","MAWBumpThread","MAWCreateOptimisticSecureMessage","MAWLocalizationType","MAWOptimisticMessageUtils","MWPActor.react","QPLUserFlow","asyncToGeneratorRuntime","cr:2472","qpl","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(){var a=(j||(j=c("useReStore")))(),e=d("MWPActor.react").useActor();return function(g,j,k,l,m,n,o,p){return a.runInTransaction(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(f){var q=(yield d("MAWOptimisticMessageUtils").getOptimisticMessageTimestamp()),r=(h||(h=d("I64"))).of_float(q);o(p);var s=(yield d("MAWCreateOptimisticSecureMessage").createOptimisticMessageTxn(a,f,e,g,j,k,l,m,n,p,r,1,p));yield f.messages.add(s);c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"after_create_optimistic_message",{instanceKey:m});s=b("cr:2472")==null?j:b("cr:2472").unvault(j);s=l!=null&&(h||(h=d("I64"))).equal(l,(i||(i=d("LSIntEnum"))).ofNumber(c("LSHotEmojiSize").SMALL))&&s==="\ud83d\udc4d"?"(Y)":j;yield d("MAWBumpThread").threadMutation(f,k,r,r,d("MAWAdminMsg").buildLocalizedString([s],[],d("MAWLocalizationType").CURRENT_USER_SEND_TEXT),e);return{offlineMsgId:p,offlineMsgTimestamp:q}});return function(a){return f.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":59")}}g["default"]=a}),98);
__d("useMAWCreateOptimisticSecureMessageWithAttachments",["I64","LSAuthorityLevel","LSIntEnum","MAWAdminMsg","MAWBumpThread","MAWCreateOptimisticSecureMessage","MAWLocalizationType","MAWOptimisticMessageUtils","MWPActor.react","Promise","QPLUserFlow","asyncToGeneratorRuntime","qpl","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function a(){var a=(k||(k=c("useReStore")))(),e=d("MWPActor.react").useActor();return function(g,k,n,o,p,q,r,s){return r==null?(j||(j=b("Promise"))).resolve():a.runInTransaction(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var f=s;q(f);var j=(yield d("MAWOptimisticMessageUtils").getOptimisticMessageTimestamp()),t=(h||(h=d("I64"))).of_float(j),u=(yield d("MAWCreateOptimisticSecureMessage").createOptimisticMessageTxn(a,b,e,g,"",k,void 0,p,void 0,f,t,l(o.type)));yield b.messages.add(u);u={attachmentFbid:n,attachmentIndex:h.zero,attachmentType:r,authorityLevel:(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),filename:o.filename,hasMedia:!0,hasXma:!1,isSharable:!1,messageId:f,offlineAttachmentId:n,previewUrl:o.url,threadKey:k,timestampMs:t,transportKey:"WhatsApp"};if(o.type==="image"||o.type==="animated_image"||o.type==="video"||o.type==="sticker"){var v;u=babelHelpers["extends"]({},u,{previewHeight:((v=o.thumbnailSpec)==null?void 0:v.height)?(h||(h=d("I64"))).of_float((v=o.thumbnailSpec)==null?void 0:v.height):void 0,previewWidth:((v=o.thumbnailSpec)==null?void 0:v.width)?(h||(h=d("I64"))).of_float((v=o.thumbnailSpec)==null?void 0:v.width):void 0})}yield b.attachments.add(u);c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"after_create_optimistic_message",{instanceKey:p});v=m(o.type);v!=null&&(yield d("MAWBumpThread").threadMutation(b,k,t,t,v,e));return{offlineMsgId:f,offlineMsgTimestamp:j}});return function(a){return f.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":64")}}function l(a){switch(a){case"animated_image":return 16384;case"image":return 2;case"video":return 2;case"audio":return 4;case"document":return 64;case"sticker":return 4096;default:return 1}}function m(a){switch(a){case"animated_image":return d("MAWAdminMsg").buildLocalizedString([],[],d("MAWLocalizationType").CURRENT_USER_SEND_GIF);case"image":return d("MAWAdminMsg").buildLocalizedString([],[],d("MAWLocalizationType").CURRENT_USER_SEND_IMAGE);case"video":return d("MAWAdminMsg").buildLocalizedString([],[],d("MAWLocalizationType").CURRENT_USER_SEND_VIDEO);case"audio":return d("MAWAdminMsg").buildLocalizedString([],[],d("MAWLocalizationType").CURRENT_USER_SEND_AUDIO);case"document":return d("MAWAdminMsg").buildLocalizedString([],[],d("MAWLocalizationType").CURRENT_USER_SEND_ATTACHMENT);case"sticker":return d("MAWAdminMsg").buildLocalizedString([],[],d("MAWLocalizationType").CURRENT_USER_SEND_STICKER);default:return null}}g["default"]=a}),98);
__d("useMAWCreateOptimisticSecureMessageWithXMAAttachment",["I64","LSAuthorityLevel","LSIntEnum","MAWAdminMsg","MAWBumpThread","MAWCreateOptimisticSecureMessage","MAWLocalizationType","MAWOptimisticMessageUtils","MAWVault","MWPActor.react","MessagingAttachmentType","QPLUserFlow","asyncToGeneratorRuntime","qpl","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(){var a=(j||(j=c("useReStore")))(),e=d("MWPActor.react").useActor();return function(g,j,k,l,m,n,o,p,q,r){return a.runInTransaction(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var f,s=o;n(s);var t=(yield d("MAWOptimisticMessageUtils").getOptimisticMessageTimestamp()),u=(h||(h=d("I64"))).of_float(t);f=(yield d("MAWCreateOptimisticSecureMessage").createOptimisticMessageTxn(a,b,e,g,(f=d("MAWVault").unvault(r))!=null?f:"",j,void 0,m,void 0,s,u,1024));yield b.messages.add(f);f={attachmentFbid:k,attachmentIndex:h.zero,attachmentType:(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").XMA),authorityLevel:i.ofNumber(c("LSAuthorityLevel").OPTIMISTIC),hasMedia:!1,hasXma:!0,isSharable:!1,messageId:s,offlineAttachmentId:k,previewUrl:l==null?void 0:l.url,subtitleText:q,threadKey:j,timestampMs:u,titleText:p,transportKey:"WhatsApp"};if((l==null?void 0:l.type)==="image"){var v;f=babelHelpers["extends"]({},f,{previewHeight:((v=l.thumbnailSpec)==null?void 0:v.height)?(h||(h=d("I64"))).of_float((v=l.thumbnailSpec)==null?void 0:v.height):void 0,previewWidth:((v=l.thumbnailSpec)==null?void 0:v.width)?(h||(h=d("I64"))).of_float((v=l.thumbnailSpec)==null?void 0:v.width):void 0})}yield b.attachments.add(f);c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"after_create_optimistic_message",{instanceKey:m});yield d("MAWBumpThread").threadMutation(b,j,u,u,d("MAWAdminMsg").buildLocalizedString([d("MAWVault").unvault(r)],[],d("MAWLocalizationType").CURRENT_USER_SEND_TEXT),e);return{offlineMsgId:s,offlineMsgTimestamp:t}});return function(a){return f.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":63")}}g["default"]=a}),98);
__d("useMAWSendMessageV2",["I64","LSHotEmojiSize","LSIntEnum","MAWJobDefinitions","MAWTimedJob","MWPActor.react","MWPReplyContext.react","MWV2ComposerActionsContext.react","QPLUserFlow","WAJobOrchestratorTypes","asyncToGeneratorRuntime","qpl","react","requireDeferred","useLSMessagingInitiatingSourceNumber"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=(h||d("react")).useContext,l=c("requireDeferred")("MWLogSend").__setRef("useMAWSendMessageV2");function m(a){if(a==null)return;if((i||(i=d("I64"))).equal(a,(j||(j=d("LSIntEnum"))).ofNumber(c("LSHotEmojiSize").SMALL)))return 1;if((i||(i=d("I64"))).equal(a,(j||(j=d("LSIntEnum"))).ofNumber(c("LSHotEmojiSize").MEDIUM)))return 2;if((i||(i=d("I64"))).equal(a,(j||(j=d("LSIntEnum"))).ofNumber(c("LSHotEmojiSize").LARGE)))return 3}function a(){var a=d("MWPActor.react").useActor(),e=k(d("MWPReplyContext.react").MWPReplyContext),f=e.reply,g=c("useLSMessagingInitiatingSourceNumber")();e=k(d("MWV2ComposerActionsContext.react").MWV2ComposerActionsContext);var h=e.onMessageSendAttempt;return function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,e,j,k,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B){h==null?void 0:h(!0);j=babelHelpers["extends"]({content:o,initiatingSource:g,isFirstMsg:u,isForwarded:!1,openMessageOtid:q,openMessageParticipantCount:v,optimisticMsg:{msgId:r,ts:s},participantCount:w,s2sInstanceKey:A,s2sUserFlowQPLEvent:c("qpl")._(25313175,"1551"),source:p,specialTextSize:m(t)},x!=null&&{quote:x});y!=null&&(j.ephemeralSetting=y);z!=null&&(j.mentionedJids=[].concat(z));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"sending_message_to_wajob",{instanceKey:A});yield d("MAWTimedJob").TimedUIJobStarters.waitUntilCompleted(d("MAWJobDefinitions").createStartJobInfo("sendMsg",{args:j,chatJid:n,externalId:B,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION}}));l.onReady(function(c){var g=(i||(i=d("I64"))).to_string(e),h=t!=null?3:0;return c.log(b,{_mentionedJids:z,actor:a,attachmentFbids:[],attachmentType:h,backend:1,hasReply:f!=null,messagingThreadId:g,msgTtl:y==null?void 0:y.ephemeralExpirationInSec,offlineThreadingId:B,sendType:0,source:p,threadKey:e,threadType:k})})});return function(a,b,c,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){return e.apply(this,arguments)}}()}g["default"]=a}),98);
__d("useMarkOptimisticMessageAsFailed",["LSFactory","LSMarkOptimisticMessageFailedStoredProcedure","react","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=(i||d("react")).useCallback;function a(){var a=(h||(h=c("useReStore")))();return j(function(b,d){return a.runInTransaction(function(a){return c("LSMarkOptimisticMessageFailedStoredProcedure")(c("LSFactory")(a),{errorMessage:d,optimisticMid:b})},"readwrite",void 0,void 0,f.id+":25")},[a])}g["default"]=a}),98);
__d("useMaybeCreateThreadForMAWSendSecurMessageV2",["I64","LSDatabaseSingleton","MAWMiActMaybeCreateActThread","MWPActor.react","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(){var a=d("MWPActor.react").useActor();return function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var e=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton),f=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(e.tables.participants,["contactId"]).getKeyRange(b).map(function(a){return(i||(i=d("I64"))).to_string(a.contactId)})));return c("MAWMiActMaybeCreateActThread")(e,b,{actorId:a,participantIds:f})});return function(a){return e.apply(this,arguments)}}()}g["default"]=a}),98);
__d("useMAWSendSecureAttachmentMessageV2_DEPRECATED",["FBLogger","Int64Hooks","LSDatabaseSingleton","MAWExternalId","MAWGetEphemeralSettings","MAWMediaManagerUtils","MAWPrepareAttachmentsFromMediaManager","MAWSecureAttachmentGroupingUtils","MAWSendFileMsgIfNecessary_DEPRECATED","MAWStateContext.react","MWPActor.react","Promise","QPLUserFlow","WALoggerDeferred","asyncToGeneratorRuntime","gkx","qex","qpl","useLSMessagingInitiatingSourceNumber","useMAWCreateOptimisticSecureMessageWithAttachments","useMWLSDefaultThreadSource","useMarkOptimisticMessageAsFailed","useMaybeCreateThreadForMAWSendSecurMessageV2"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(){var a=d("MWPActor.react").useActor(),e=c("useMWLSDefaultThreadSource")(),f=c("useMaybeCreateThreadForMAWSendSecurMessageV2")(),g=c("useLSMessagingInitiatingSourceNumber")(),j=c("useMAWCreateOptimisticSecureMessageWithAttachments")(),k=d("MAWStateContext.react").useDispatchOptimisticSendMessage(),l=c("useMarkOptimisticMessageAsFailed")();return d("Int64Hooks").useCallbackInt64(function(){var m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(m){var n=m.externalAttachmentUrl,o=m.lssTraceApi,p=m.mediaStagings,q=m.messageTypeParams,r=m.onGenerateOfflineMsgId,s=m.reply,t=m.s2sInstanceKey,u=m.stickerId,v=m.thread;m=m.voiceClip;var w=new Map();try{var x=q.hasAttachment;if(!x)return;c("qex")._("536")===!0?x=d("MAWSecureAttachmentGroupingUtils").orderMediaStagingsForGrouping(p):x=p;var y=new Map();c("gkx")("2237")&&(o==null?void 0:o.addMarkerPoint("create_optimistic_message_start","AppTiming"),yield (i||(i=b("Promise"))).all(x.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("MAWMediaManagerUtils").MAWMediaManagerAttachmentsV2.get(a.offlineAttachmentId);b=b==null?void 0:b.optimisticMedia;if(b==null){c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure optimistic media message: unable to find optimistic media attachment in useMAWSendSecureAttachmentMessage");return null}var e=d("MAWExternalId").generateExternalId();b=(yield j(s,v.threadKey,a.offlineAttachmentId,b,t,r,a.attachmentType,e));if(b==null){c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure optimistic media message: unable to create optimistic message");return null}w.set(a.offlineAttachmentId,{externalId:e,offlineMsgId:b.offlineMsgId,offlineMsgTimestamp:b.offlineMsgTimestamp});k(b.offlineMsgId,b.offlineMsgTimestamp)});return function(b){return a.apply(this,arguments)}}())),o==null?void 0:o.addMarkerPoint("create_optimistic_message_end","AppTiming"));yield (i||(i=b("Promise"))).all(x.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("MAWMediaManagerUtils").MAWMediaManagerAttachmentsV2.get(a.offlineAttachmentId);if(b==null){c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure media message: unable to find media attachment in useMAWSendSecureAttachmentMessage");return}yield b.processedMediaPromise.then(function(b){y.set(a.offlineAttachmentId,b)})});return function(b){return a.apply(this,arguments)}}()));o=d("MAWPrepareAttachmentsFromMediaManager").prepareAttachmentsFromMediaManagerImpl(x,q,r,y);x=o.attachmentOfflineId;q=o.attachments;o=e(v.threadKey);var z=(yield i.all([(h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,f(v.threadKey)])),A=z[0];z=z[1];var B=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(z.jid,v.threadKey));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"fetch_ephemeral_settings",{instanceKey:t});x={actorId:a,attachmentOfflineId:x,attachments:q,db:A,ephemeralSetting:B,externalAttachmentUrl:n,initiatingSource:g,isFirstMsg:z.created,offlineAttachmentIdToMessageData:w,reply:s,s2sInstanceKey:t,source:o,stickerId:u,thread:v,threadId:z.chatId,voiceClip:m};return d("MAWSendFileMsgIfNecessary_DEPRECATED").sendFileMsgIfNecessary_DEPRECATED(A,x)}catch(a){var C=a instanceof Error?a.message:"Fail to send secure attachment message";w.forEach(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.offlineMsgId;yield l(a,C)});return function(b){return a.apply(this,arguments)}}());yield d("WALoggerDeferred").logWithTags(["MAWSendSecureMessageV2","Composer","useMAWSendSecureAttachmentMessage"],["Send attachment message failed:"+JSON.stringify(a)],"ERROR");throw a}finally{p.map(function(a){return d("MAWMediaManagerUtils").MAWMediaManagerAttachmentsV2["delete"](a.offlineAttachmentId)})}});return function(a){return m.apply(this,arguments)}}(),[a,j,k,e,g,l,f])}g["default"]=a}),98);
__d("useMAWSendSecureAttachmentMessage_DEPRECATED",["Int64Hooks","LSDatabaseSingleton","MAWGetEphemeralSettings","MAWSendFileMsgIfNecessary_DEPRECATED","MWPActor.react","Promise","QPLUserFlow","asyncToGeneratorRuntime","qpl","useLSMessagingInitiatingSourceNumber","useMWLSDefaultThreadSource","useMaybeCreateThreadForMAWSendSecurMessageV2"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(){var a=d("MWPActor.react").useActor(),e=c("useMWLSDefaultThreadSource")(),f=c("useMaybeCreateThreadForMAWSendSecurMessageV2")(),g=c("useLSMessagingInitiatingSourceNumber")();return d("Int64Hooks").useCallbackInt64(function(){var j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(j){var k=j.externalAttachmentUrl,l=j.messageTypeParams,m=j.preparedAttachments,n=j.reply,o=j.s2sInstanceKey,p=j.stickerId,q=j.thread;j=j.voiceClip;l=l.hasAttachment;if(!l)return;l=m.attachmentOfflineId;m=m.attachments;var r=e(q.threadKey),s=(yield (i||(i=b("Promise"))).all([(h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,f(q.threadKey)])),t=s[0];s=s[1];var u=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(s.jid,q.threadKey));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"fetch_ephemeral_settings",{instanceKey:o});l={actorId:a,attachmentOfflineId:l,attachments:m,db:t,ephemeralSetting:u,externalAttachmentUrl:k,initiatingSource:g,isFirstMsg:s.created,reply:n,s2sInstanceKey:o,source:r,stickerId:p,thread:q,threadId:s.chatId,voiceClip:j};return d("MAWSendFileMsgIfNecessary_DEPRECATED").sendFileMsgIfNecessary_DEPRECATED(t,l)});return function(a){return j.apply(this,arguments)}}(),[a,e,g,f])}g["default"]=a}),98);
__d("useMarkOptimisticMessagesAsFailed",["LSFactory","LSMarkOptimisticMessageFailedStoredProcedure","Promise","asyncToGeneratorRuntime","react","useAsyncReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=(i||d("react")).useCallback;function a(){var a=c("useAsyncReStore")();return j(function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(d,e){var g=(yield a);return g.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield (h||(h=b("Promise"))).all(d.map(function(b){return c("LSMarkOptimisticMessageFailedStoredProcedure")(c("LSFactory")(a),{errorMessage:e,optimisticMid:b})}))});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":27")});return function(a,b){return d.apply(this,arguments)}}(),[a])}g["default"]=a}),98);
__d("useMAWSendSecureGifAttachmentMessage",["FBLogger","Int64Hooks","LSDatabaseSingleton","LSIntEnum","MAWExternalId","MAWFetchExternalAttachmentBlob","MAWGetEphemeralSettings","MAWImagePreProcess","MAWSendFileMsgIfNecessaryV2","MAWSendFileMsgIfNecessary_DEPRECATED","MAWStateContext.react","MWPActor.react","MessagingAttachmentType","Promise","QPLUserFlow","WALoggerDeferred","asyncToGeneratorRuntime","qex","qpl","useLSMessagingInitiatingSourceNumber","useMAWCreateOptimisticSecureMessageWithAttachments","useMWLSDefaultThreadSource","useMarkOptimisticMessagesAsFailed","useMaybeCreateThreadForMAWSendSecurMessageV2"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(){var a=d("MWPActor.react").useActor(),e=c("useMWLSDefaultThreadSource")(),f=c("useMaybeCreateThreadForMAWSendSecurMessageV2")(),g=c("useLSMessagingInitiatingSourceNumber")(),k=c("useMAWCreateOptimisticSecureMessageWithAttachments")(),l=d("MAWStateContext.react").useDispatchOptimisticSendMessage(),m=c("useMarkOptimisticMessagesAsFailed")();return d("Int64Hooks").useCallbackInt64(function(){var n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=n.externalAttachmentUrl,p=n.lssTraceApi,q=n.onGenerateOfflineMsgId,r=n.reply,s=n.s2sInstanceKey;n=n.thread;var t=new Map();try{var u=d("MAWExternalId").generateExternalId(),v=d("MAWExternalId").generateExternalId(),w=e(n.threadKey),x=(yield (j||(j=b("Promise"))).all([(h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,f(n.threadKey)])),y=x[0];x=x[1];var z=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(x.jid,n.threadKey));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"fetch_ephemeral_settings",{instanceKey:s});if(c("qex")._("1427")===!0){p==null?void 0:p.addMarkerPoint("fetch_external_attachment_blob_start","AppTiming");var A=(yield d("MAWFetchExternalAttachmentBlob").fetchExternalAttachmentBlob(o,s));A=new File([A],"gifFromPicker",{type:A.type});p==null?void 0:p.addMarkerPoint("fetch_external_attachment_blob_end","AppTiming");p==null?void 0:p.addMarkerPoint("create_optimistic_message_start","AppTiming");var B=(yield d("MAWImagePreProcess").optimisticImagePreprocess(A,!1));B=(yield k(r,n.threadKey,u,B,s,q,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").ANIMATED_IMAGE),v));B!=null?(t.set(u,{externalId:u,offlineMsgId:B.offlineMsgId,offlineMsgTimestamp:B.offlineMsgTimestamp}),l(B.offlineMsgId,B.offlineMsgTimestamp),p==null?void 0:p.addMarkerPoint("create_optimistic_message_success","AppTiming")):(c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure optimistic media message: unable to create optimistic message for GIF"),p==null?void 0:p.addMarkerPoint("create_optimistic_message_fail","AppTiming"));p==null?void 0:p.addMarkerPoint("preprocess_start","AppTiming");q=(yield d("MAWImagePreProcess").imagePreprocess(A,!1));p==null?void 0:p.addMarkerPoint("preprocess_end","AppTiming");v=[[q,u]];B={actorId:a,attachments:v,db:y,ephemeralSetting:z,initiatingSource:g,isFirstMsg:x.created,offlineAttachmentIdToMessageData:t,reply:r,s2sInstanceKey:s,source:w,thread:n,threadId:x.chatId};return yield d("MAWSendFileMsgIfNecessaryV2").sendFileMsgIfNecessaryV2(y,B)}else{A={actorId:a,attachmentOfflineId:u,attachments:[],db:y,ephemeralSetting:z,externalAttachmentUrl:o,initiatingSource:g,isFirstMsg:x.created,offlineAttachmentIdToMessageData:new Map(),reply:r,s2sInstanceKey:s,source:w,stickerId:void 0,thread:n,threadId:x.chatId,voiceClip:void 0};return yield d("MAWSendFileMsgIfNecessary_DEPRECATED").sendFileMsgIfNecessary_DEPRECATED(y,A)}}catch(a){p=a instanceof Error?a.message:"Fail to send secure attachment message";q=Array.from(t.values()).map(function(a){a=a.offlineMsgId;return a});yield m(q,p);yield d("WALoggerDeferred").logWithTags(["MAWSendSecureMessageV2","Composer","useMAWSendSecureAttachmentMessage"],["Send attachment message failed:"+JSON.stringify(a)],"ERROR");throw a}});return function(a){return n.apply(this,arguments)}}(),[a,k,l,e,g,m,f])}g["default"]=a}),98);
__d("useMAWSendSecureTextMessage",["MAWBridgeSendAndReceive","MAWDbMsg","MAWExternalId","MAWGetEphemeralSettings","MAWStateContext.react","MAWVault","Promise","WALoggerDeferred","asyncToGeneratorRuntime","emptyFunction","promiseDone","react","useMAWCreateOptimisticSecureMessageV2","useMAWSendMessageV2","useMWLSDefaultThreadSource","useMarkOptimisticMessageAsFailed","useMaybeCreateThreadForMAWSendSecurMessageV2"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=(i||d("react")).useCallback;function a(){var a=c("useMWLSDefaultThreadSource")(),e=c("useMaybeCreateThreadForMAWSendSecurMessageV2")(),f=c("useMAWSendMessageV2")(),g=c("useMAWCreateOptimisticSecureMessageV2")(),i=c("useMarkOptimisticMessageAsFailed")(),k=d("MAWStateContext.react").useDispatchOptimisticSendMessage();return j(function(){var j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(j,l){var m=l.hotEmojiSize,n=l.lssTraceApi,o=l.mentionedJids,p=l.messageText,q=l.onGenerateOfflineMsgId,r=l.reply,s=l.s2sInstanceKey;l=l.thread;var t=d("MAWExternalId").generateExternalId(),u=null;try{var v;n==null?void 0:n.addMarkerPoint("create_optimistic_message_start","AppTiming");q=(yield (h||(h=b("Promise"))).all([e(l.threadKey),g(r,d("MAWVault").vault(p),l.threadKey,m,(v=s)!=null?v:0,o,(v=q)!=null?v:c("emptyFunction"),t)]));v=q[0];q=q[1];n==null?void 0:n.addMarkerPoint("create_optimistic_message_end","AppTiming");u=q.offlineMsgId;n=q.offlineMsgTimestamp;k(u,Date.now());q=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(v.jid,l.threadKey));var w=a(l.threadKey),x=null;if(r!=null){r=d("MAWDbMsg").toMsgId(r.messageId);r!=null&&(x=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:r})))}return f(j,l.threadKey,v.chatId,l.threadType,v.jid,p,w,void 0,u,n,m,v.created,void 0,void 0,x,q,o,s,t)}catch(a){r=a instanceof Error?a.message:"Fail to send secure text message";u!=null&&c("promiseDone")(i(u,r));yield d("WALoggerDeferred").logWithTags(["MAWSendSecureMessageV2","Composer","useMAWSendSecureTextMessage"],["Send text message failed:"+JSON.stringify(a)],"ERROR");throw a}});return function(a,b){return j.apply(this,arguments)}}(),[g,k,a,i,e,f])}g["default"]=a}),98);
__d("useMAWSendSecureLinkXMAMessage",["ConstUriUtils","FBLogger","Int64Hooks","MAWBridgeSendAndReceive","MAWDbMsg","MAWExternalId","MAWExternalLinkUtil","MAWFindFirstUrl","MAWImagePreProcess","MAWSendExternalLinkXMAV2","MAWSendExternalLinkXMA_DEPRECATED","MAWStateContext.react","MAWVault","asyncToGeneratorRuntime","emptyFunction","gkx","qex","useMAWCreateOptimisticSecureMessageWithXMAAttachment","useMAWSendSecureTextMessage","useMWLSDefaultThreadSource","useMarkOptimisticMessageAsFailed","useMaybeCreateThreadForMAWSendSecurMessageV2"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=c("useMWLSDefaultThreadSource")(),e=c("useMaybeCreateThreadForMAWSendSecurMessageV2")(),f=c("useMAWSendSecureTextMessage")(),g=c("gkx")("3119"),i=c("useMAWCreateOptimisticSecureMessageWithXMAAttachment")(),k=d("MAWStateContext.react").useDispatchOptimisticSendMessage(),l=c("useMarkOptimisticMessageAsFailed")();return d("Int64Hooks").useCallbackInt64(function(){var m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,m){var n=m.currentDraftId,o=m.lssTraceApi,p=m.mentionedJids,q=m.messageText,r=m.onGenerateOfflineMsgId,s=m.reply,t=m.s2sInstanceKey,u=m.thread;m=m.threadKey;var v=d("MAWExternalId").generateExternalId();try{n=g?yield h(b,n):yield j(q);if(n==null)return f(b,{mentionedJids:p,messageText:q,onGenerateOfflineMsgId:r,reply:s,s2sInstanceKey:t,thread:u});b=n.externalLinkUrl;p=n.linkPreviewData;var w=null;if(s!=null){var x=d("MAWDbMsg").toMsgId(s.messageId);x!=null&&(w=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:x})))}x=d("MAWExternalId").generateExternalId();r==null?void 0:r(x);var y=a(m),z=(yield e(m));if(c("qex")._("1562")===!0){o==null?void 0:o.addMarkerPoint("fetch_link_preview_blob_start","AppTiming");var A=(yield d("MAWExternalLinkUtil").getImageBlobResponse(p==null?void 0:p.thumbnail_url));o==null?void 0:o.addMarkerPoint("fetch_link_preview_blob_end","AppTiming");o==null?void 0:o.addMarkerPoint("create_optimistic_message_start","AppTiming");var B=null;if(A!=null&&d("MAWExternalLinkUtil").allowedPreviewTypes.includes(A.type)){var C=new File([A],"preview",{type:A.type});B=(yield d("MAWImagePreProcess").optimisticImagePreprocess(C))}C=(yield i(s,u.threadKey,x,B,t,(C=r)!=null?C:c("emptyFunction"),v,(u=(s=n.linkPreviewData)==null?void 0:s.title)!=null?u:(B=d("ConstUriUtils").getUri(b))==null?void 0:B.getDomain(),(r=n.linkPreviewData)==null?void 0:r.author_name,d("MAWVault").vault(q)));s=C!=null?{externalId:v,offlineMsgId:C.offlineMsgId,offlineMsgTimestamp:C.offlineMsgTimestamp}:void 0;s!=null?(k(s.offlineMsgId,s.offlineMsgTimestamp),o==null?void 0:o.addMarkerPoint("create_optimistic_message_success","AppTiming")):(c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure optimistic media message: unable to create optimistic message for GIF"),o==null?void 0:o.addMarkerPoint("create_optimistic_message_fail","AppTiming"));return d("MAWSendExternalLinkXMAV2").sendExternalLinkXMAV2(q,p,A,b,z.jid,t,y,m,x,(u=w)!=null?u:void 0,s)}else{return d("MAWSendExternalLinkXMA_DEPRECATED").sendExternalLinkXMA_DEPRECATED(q,p,b,z.jid,t,y,m,x,(B=w)!=null?B:void 0)}}catch(a){n=a instanceof Error?a.message:"Fail to send secure attachment message";yield l(v,n);c("FBLogger")("messenger_web_sharing").catching(a).mustfix("[External link] Failed to send external link XMA ");throw a}});return function(a,b){return m.apply(this,arguments)}}(),[i,k,a,g,l,e,f])}function h(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){if(b==null)return null;a=(yield a.runInTransaction(function(a){return a.e2ee_composer_draft_link_preview.get(b).then(function(a){return(a==null?void 0:a.data)==null?null:a==null?void 0:a.data})},"readonly",void 0,void 0,f.id+":262"));a=JSON.parse((a=a)!=null?a:"{}");return Object.keys(a).length===0||a.url==null?null:{externalLinkUrl:a==null?void 0:a.url,linkPreviewData:a}});return i.apply(this,arguments)}function j(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=d("MAWFindFirstUrl").findFirstUrl(a);if(a==null||a.length===0)return null;var b=a[0];a=d("MAWExternalLinkUtil").findFirstAvailableOembedUrlAndRequestPair(a);b=b.entity.url;var e=null;if(a!=null){b=a.oEmbedUrl;try{e=(yield d("MAWExternalLinkUtil").getOembedResponse(a.oEmbedRequest))}catch(a){c("FBLogger")("messenger_web_sharing").catching(a).mustfix("[External link] Failed to send External Link XMA.")}}return{externalLinkUrl:b,linkPreviewData:e}});return k.apply(this,arguments)}g["default"]=a}),98);
__d("useMAWSendSecureStagedMediaAttachmentMessage",["FBLogger","Int64Hooks","LSDatabaseSingleton","MAWExternalId","MAWGetEphemeralSettings","MAWMediaManagerUtils","MAWPrepareAttachmentsFromMediaManager","MAWSecureAttachmentGroupingUtils","MAWSendFileMsgIfNecessaryV2","MAWSendFileMsgIfNecessary_DEPRECATED","MAWStateContext.react","MWPActor.react","Promise","QPLUserFlow","WALoggerDeferred","asyncToGeneratorRuntime","gkx","qex","qpl","useLSMessagingInitiatingSourceNumber","useMAWCreateOptimisticSecureMessageWithAttachments","useMWLSDefaultThreadSource","useMarkOptimisticMessagesAsFailed","useMaybeCreateThreadForMAWSendSecurMessageV2"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(){var a=d("MWPActor.react").useActor(),e=c("useMWLSDefaultThreadSource")(),f=c("useMaybeCreateThreadForMAWSendSecurMessageV2")(),g=c("useLSMessagingInitiatingSourceNumber")(),j=c("useMAWCreateOptimisticSecureMessageWithAttachments")(),k=d("MAWStateContext.react").useDispatchOptimisticSendMessage(),l=c("useMarkOptimisticMessagesAsFailed")();return d("Int64Hooks").useCallbackInt64(function(){var m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(m){var n=m.lssTraceApi,o=m.mediaStagings,p=m.messageTypeParams,q=m.onGenerateOfflineMsgId,r=m.reply,s=m.s2sInstanceKey,t=m.thread,u=new Map();try{c("qex")._("536")===!0?m=d("MAWSecureAttachmentGroupingUtils").orderMediaStagingsForGrouping(o):m=o;var v=new Map();c("gkx")("2237")&&(n==null?void 0:n.addMarkerPoint("create_optimistic_message_start","AppTiming"),yield (i||(i=b("Promise"))).all(m.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("MAWMediaManagerUtils").MAWMediaManagerAttachmentsV2.get(a.offlineAttachmentId);b=b==null?void 0:b.optimisticMedia;if(b==null){c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure optimistic media message: unable to find optimistic media attachment in useMAWSendSecureAttachmentMessage");return null}var e=d("MAWExternalId").generateExternalId();b=(yield j(r,t.threadKey,a.offlineAttachmentId,b,s,q,a.attachmentType,e));if(b==null){c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure optimistic media message: unable to create optimistic message");return null}u.set(a.offlineAttachmentId,{externalId:e,offlineMsgId:b.offlineMsgId,offlineMsgTimestamp:b.offlineMsgTimestamp});k(b.offlineMsgId,b.offlineMsgTimestamp)});return function(b){return a.apply(this,arguments)}}())),n==null?void 0:n.addMarkerPoint("create_optimistic_message_end","AppTiming"));yield (i||(i=b("Promise"))).all(m.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("MAWMediaManagerUtils").MAWMediaManagerAttachmentsV2.get(a.offlineAttachmentId);if(b==null){c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure media message: unable to find media attachment in useMAWSendSecureAttachmentMessage");return}yield b.processedMediaPromise.then(function(b){v.set(a.offlineAttachmentId,b)})});return function(b){return a.apply(this,arguments)}}()));n=d("MAWPrepareAttachmentsFromMediaManager").prepareAttachmentsFromMediaManagerImpl(m,p,q,v);m=n.attachmentOfflineId;p=n.attachments;n=e(t.threadKey);var w=(yield i.all([(h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,f(t.threadKey)])),x=w[0];w=w[1];var y=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(w.jid,t.threadKey));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"fetch_ephemeral_settings",{instanceKey:s});if(c("qex")._("1427")===!0){var z={actorId:a,attachments:p,db:x,ephemeralSetting:y,initiatingSource:g,isFirstMsg:w.created,offlineAttachmentIdToMessageData:u,reply:r,s2sInstanceKey:s,source:n,thread:t,threadId:w.chatId};return yield d("MAWSendFileMsgIfNecessaryV2").sendFileMsgIfNecessaryV2(x,z)}else{z={actorId:a,attachmentOfflineId:m,attachments:p,db:x,ephemeralSetting:y,externalAttachmentUrl:void 0,initiatingSource:g,isFirstMsg:w.created,offlineAttachmentIdToMessageData:u,reply:r,s2sInstanceKey:s,source:n,stickerId:void 0,thread:t,threadId:w.chatId,voiceClip:void 0};return yield d("MAWSendFileMsgIfNecessary_DEPRECATED").sendFileMsgIfNecessary_DEPRECATED(x,z)}}catch(a){m=a instanceof Error?a.message:"Fail to send secure attachment message";p=Array.from(u.values()).map(function(a){a=a.offlineMsgId;return a});yield l(p,m);yield d("WALoggerDeferred").logWithTags(["MAWSendSecureMessageV2","Composer","useMAWSendSecureAttachmentMessage"],["Send attachment message failed:"+JSON.stringify(a)],"ERROR");throw a}finally{o.map(function(a){return d("MAWMediaManagerUtils").MAWMediaManagerAttachmentsV2["delete"](a.offlineAttachmentId)})}});return function(a){return m.apply(this,arguments)}}(),[a,j,k,e,g,l,f])}g["default"]=a}),98);
__d("useMAWSendSecureStickerAttachmentMessage",["FBLogger","Int64Hooks","LSDatabaseSingleton","LSIntEnum","MAWExternalId","MAWFetchExternalAttachmentBlob","MAWGetEphemeralSettings","MAWImagePreProcess","MAWSendFileMsgIfNecessaryV2","MAWSendFileMsgIfNecessary_DEPRECATED","MAWStateContext.react","MWPActor.react","MessagingAttachmentType","Promise","QPLUserFlow","WALoggerDeferred","asyncToGeneratorRuntime","qex","qpl","useLSMessagingInitiatingSourceNumber","useMAWCreateOptimisticSecureMessageWithAttachments","useMWLSDefaultThreadSource","useMarkOptimisticMessagesAsFailed","useMaybeCreateThreadForMAWSendSecurMessageV2"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(){var a=d("MWPActor.react").useActor(),e=c("useMWLSDefaultThreadSource")(),f=c("useMaybeCreateThreadForMAWSendSecurMessageV2")(),g=c("useLSMessagingInitiatingSourceNumber")(),k=c("useMAWCreateOptimisticSecureMessageWithAttachments")(),l=d("MAWStateContext.react").useDispatchOptimisticSendMessage(),m=c("useMarkOptimisticMessagesAsFailed")();return d("Int64Hooks").useCallbackInt64(function(){var n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=n.externalAttachmentUrl,p=n.lssTraceApi,q=n.onGenerateOfflineMsgId,r=n.reply,s=n.s2sInstanceKey,t=n.stickerId;n=n.thread;var u=new Map();try{var v=d("MAWExternalId").generateExternalId(),w=d("MAWExternalId").generateExternalId(),x=e(n.threadKey),y=(yield (j||(j=b("Promise"))).all([(h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,f(n.threadKey)])),z=y[0];y=y[1];var A=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(y.jid,n.threadKey));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"fetch_ephemeral_settings",{instanceKey:s});if(c("qex")._("1427")===!0){p==null?void 0:p.addMarkerPoint("fetch_external_attachment_blob_start","AppTiming");var B=(yield d("MAWFetchExternalAttachmentBlob").fetchExternalAttachmentBlob(o,s)),C=new File([B],"stickerFromPicker",{type:B.type});p==null?void 0:p.addMarkerPoint("fetch_external_attachment_blob_end","AppTiming");p==null?void 0:p.addMarkerPoint("create_optimistic_message_start","AppTiming");C=(yield d("MAWImagePreProcess").optimisticImagePreprocess(C,!0));C=(yield k(r,n.threadKey,v,C,s,q,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").STICKER),w));C!=null?(u.set(v,{externalId:v,offlineMsgId:C.offlineMsgId,offlineMsgTimestamp:C.offlineMsgTimestamp}),l(C.offlineMsgId,C.offlineMsgTimestamp),p==null?void 0:p.addMarkerPoint("create_optimistic_message_success","AppTiming")):(c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure optimistic media message: unable to create optimistic message for sticker"),p==null?void 0:p.addMarkerPoint("create_optimistic_message_fail","AppTiming"));p==null?void 0:p.addMarkerPoint("preprocess_start","AppTiming");q=(yield d("MAWImagePreProcess").imagePreprocess(new File([B],"stickerFromPicker",{type:B.type}),!0));p==null?void 0:p.addMarkerPoint("preprocess_end","AppTiming");w=[[q,v]];C={actorId:a,attachments:w,db:z,ephemeralSetting:A,initiatingSource:g,isFirstMsg:y.created,offlineAttachmentIdToMessageData:u,reply:r,s2sInstanceKey:s,source:x,thread:n,threadId:y.chatId};return yield d("MAWSendFileMsgIfNecessaryV2").sendFileMsgIfNecessaryV2(z,C)}else{B={actorId:a,attachmentOfflineId:v,attachments:[],db:z,ephemeralSetting:A,externalAttachmentUrl:o,initiatingSource:g,isFirstMsg:y.created,offlineAttachmentIdToMessageData:new Map(),reply:r,s2sInstanceKey:s,source:x,stickerId:t,thread:n,threadId:y.chatId,voiceClip:void 0};return yield d("MAWSendFileMsgIfNecessary_DEPRECATED").sendFileMsgIfNecessary_DEPRECATED(z,B)}}catch(a){p=a instanceof Error?a.message:"Fail to send secure attachment message";q=Array.from(u.values()).map(function(a){a=a.offlineMsgId;return a});yield m(q,p);yield d("WALoggerDeferred").logWithTags(["MAWSendSecureMessageV2","Composer","useMAWSendSecureAttachmentMessage"],["Send attachment message failed:"+JSON.stringify(a)],"ERROR");throw a}});return function(a){return n.apply(this,arguments)}}(),[a,k,l,e,g,m,f])}g["default"]=a}),98);
__d("useMAWSendSecureVoiceClipAttachmentMessage",["FBLogger","Int64Hooks","LSDatabaseSingleton","LSIntEnum","MAWAudioPreProcess","MAWExternalId","MAWGetEphemeralSettings","MAWSendFileMsgIfNecessaryV2","MAWSendFileMsgIfNecessary_DEPRECATED","MAWStateContext.react","MWPActor.react","MessagingAttachmentType","Promise","QPLUserFlow","WALoggerDeferred","asyncToGeneratorRuntime","qex","qpl","useLSMessagingInitiatingSourceNumber","useMAWCreateOptimisticSecureMessageWithAttachments","useMWLSDefaultThreadSource","useMarkOptimisticMessagesAsFailed","useMaybeCreateThreadForMAWSendSecurMessageV2"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(){var a=d("MWPActor.react").useActor(),e=c("useMWLSDefaultThreadSource")(),f=c("useMaybeCreateThreadForMAWSendSecurMessageV2")(),g=c("useLSMessagingInitiatingSourceNumber")(),k=c("useMAWCreateOptimisticSecureMessageWithAttachments")(),l=d("MAWStateContext.react").useDispatchOptimisticSendMessage(),m=c("useMarkOptimisticMessagesAsFailed")();return d("Int64Hooks").useCallbackInt64(function(){var n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=n.lssTraceApi,p=n.onGenerateOfflineMsgId,q=n.reply,r=n.s2sInstanceKey,s=n.thread;n=n.voiceClip;var t=new Map();try{var u=d("MAWExternalId").generateExternalId(),v=d("MAWExternalId").generateExternalId(),w=e(s.threadKey),x=(yield (j||(j=b("Promise"))).all([(h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,f(s.threadKey)])),y=x[0];x=x[1];var z=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(x.jid,s.threadKey));c("QPLUserFlow").addPoint(c("qpl")._(25313175,"1551"),"fetch_ephemeral_settings",{instanceKey:r});if(c("qex")._("1427")===!0){var A=(yield d("MAWAudioPreProcess").optimisticAudioPreprocess(n.file));o==null?void 0:o.addMarkerPoint("create_optimistic_message_start","AppTiming");A=(yield k(q,s.threadKey,u,A,r,p,(i||(i=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").AUDIO),v));A!=null?(t.set(u,{externalId:u,offlineMsgId:A.offlineMsgId,offlineMsgTimestamp:A.offlineMsgTimestamp}),l(A.offlineMsgId,A.offlineMsgTimestamp),o==null?void 0:o.addMarkerPoint("create_optimistic_message_success","AppTiming")):(c("FBLogger")("messenger_web_media").mustfix("Failed while sending secure optimistic media message: unable to create optimistic message for GIF"),o==null?void 0:o.addMarkerPoint("create_optimistic_message_fail","AppTiming"));p={durations:n.duration||0,file:n.file,isPtt:!0,type:"audio"};v=[[p,u]];A={actorId:a,attachments:v,db:y,ephemeralSetting:z,initiatingSource:g,isFirstMsg:x.created,offlineAttachmentIdToMessageData:t,reply:q,s2sInstanceKey:r,source:w,thread:s,threadId:x.chatId};return yield d("MAWSendFileMsgIfNecessaryV2").sendFileMsgIfNecessaryV2(y,A)}else{o={actorId:a,attachmentOfflineId:u,attachments:[],db:y,ephemeralSetting:z,externalAttachmentUrl:void 0,initiatingSource:g,isFirstMsg:x.created,offlineAttachmentIdToMessageData:new Map(),reply:q,s2sInstanceKey:r,source:w,stickerId:void 0,thread:s,threadId:x.chatId,voiceClip:n};return yield d("MAWSendFileMsgIfNecessary_DEPRECATED").sendFileMsgIfNecessary_DEPRECATED(y,o)}}catch(a){p=a instanceof Error?a.message:"Fail to send secure attachment message";v=Array.from(t.values()).map(function(a){a=a.offlineMsgId;return a});yield m(v,p);yield d("WALoggerDeferred").logWithTags(["MAWSendSecureMessageV2","Composer","useMAWSendSecureAttachmentMessage"],["Send attachment message failed:"+JSON.stringify(a)],"ERROR");throw a}});return function(a){return n.apply(this,arguments)}}(),[a,k,l,e,g,m,f])}g["default"]=a}),98);
__d("useMAWUpdateThreadCapabilities",["LSMessagingThreadTypeUtil","MAWUpdateLSThreadCapabilities","Promise","react","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=(j||d("react")).useCallback;function a(){var a=(i||(i=c("useReStore")))();return k(function(c){return!d("LSMessagingThreadTypeUtil").isOneToOne(c.threadType)?(h||(h=b("Promise"))).resolve():a.runInTransaction(function(a){return d("MAWUpdateLSThreadCapabilities").updateNonMessageRequestThreadTxn(a,c.threadKey)},"readwrite",void 0,void 0,f.id+":37")},[a])}g["default"]=a}),98);
__d("useMAWSendSecureMessageV2Impl",["FBLogger","I64","Int64Hooks","LSIntEnum","LSMessagingThreadTypeUtil","MAWOptimisticUpdateContactRelationship","MAWPrepareAttachmentsFromMediaManager","MWLSLogSend","MWPActor.react","MWPReplyContext.react","MWPreloadableQueries","MWSharedMsgLogUtils","MWVersion","MessageRequestsLog","Promise","ReQL","WALoggerDeferred","asyncToGeneratorRuntime","gkx","qex","react","sendToSentQPLLogger","sendToSentQPLUtils","useAsyncReStore","useLSMessagingInitiatingSource","useMAWSendSecureAttachmentMessageV2_DEPRECATED","useMAWSendSecureAttachmentMessage_DEPRECATED","useMAWSendSecureGifAttachmentMessage","useMAWSendSecureLinkXMAMessage","useMAWSendSecureStagedMediaAttachmentMessage","useMAWSendSecureStickerAttachmentMessage","useMAWSendSecureTextMessage","useMAWSendSecureVoiceClipAttachmentMessage","useMAWUpdateThreadCapabilities","useMWLSUnarchiveThread"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=(i||d("react")).useContext;function a(a){var e=d("MWPActor.react").useActor(),f=l(d("MWPReplyContext.react").MWPReplyContext),g=f.clearReply,i=c("useLSMessagingInitiatingSource")(),m=c("useAsyncReStore")(),n=c("useMAWSendSecureTextMessage")(),o=c("useMAWSendSecureLinkXMAMessage")(),p=c("useMAWSendSecureAttachmentMessage_DEPRECATED")(),q=c("useMAWSendSecureAttachmentMessageV2_DEPRECATED")(),r=c("useMAWSendSecureGifAttachmentMessage")(),s=c("useMAWSendSecureStagedMediaAttachmentMessage")(),t=c("useMAWSendSecureStickerAttachmentMessage")(),u=c("useMAWSendSecureVoiceClipAttachmentMessage")(),v=c("useMWLSUnarchiveThread")(),w=c("useMAWUpdateThreadCapabilities")();return d("Int64Hooks").useCallbackInt64(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(f){var l=f.currentDraftId,x=f.externalAttachmentUrl,y=f.hotEmojiSize,z=f.lssTraceApi,A=f.mentionedJids,B=f.messageText,C=f.reply,D=f.s2sInstanceKey,E=D===void 0?0:D;D=f.stickerId;var F=f.thread;f=f.voiceClip;yield d("WALoggerDeferred").logWithTags(["MAWSendSecureMessageV2","Composer"],["Starting message send"],"LOG");d("sendToSentQPLLogger").markSendToSentPoint(E,"send_secure_message_started");z.addMarkerPoint("send_secure_message_started","AppTiming");var G=(yield m),H=d("LSMessagingThreadTypeUtil").isMessageRequest(F),I=(j||(j=d("I64"))).equal(F.parentThreadKey,(k||(k=d("LSIntEnum"))).ofNumber(-10)),J=(yield d("ReQL").toArrayAsync(d("MWPreloadableQueries").getMediaStagingQuery(G,F.threadKey))),K=d("MWSharedMsgLogUtils").getMessageTypeParams(F.threadType,B,y,C,D,x,f,J);d("sendToSentQPLLogger").addSendToSentAnnotations(E,yield d("MWSharedMsgLogUtils").getSendToSentAnnotations(F,K,i));d("MWSharedMsgLogUtils").addSendMessageMetadataForInteractionTrace(z,K,F,i);var L=function(a){d("MWLSLogSend").logSentHeroInteraction(z,a,{initiatingSource:i,isMessageRequest:H,mwVersion:d("MWVersion").v2,threadType:F.threadType}),d("sendToSentQPLLogger").markSendToSentPoint(E,"offline_msg_id_generated"),d("sendToSentQPLUtils").setS2sKeyForOfflineMessageId(a,E)},M=[],N=K.hasAttachment,O=K.hasLinks;B!=null&&B!==""&&(O?M.push(o(G,{currentDraftId:l,lssTraceApi:z,mentionedJids:A,messageText:B,onGenerateOfflineMsgId:N?void 0:L,reply:C,s2sInstanceKey:E,thread:F,threadKey:F.threadKey})):M.push(n(G,{hotEmojiSize:y,lssTraceApi:z,mentionedJids:A,messageText:B,onGenerateOfflineMsgId:N?void 0:L,reply:C,s2sInstanceKey:E,thread:F})));l=!0;if(N)if(c("gkx")("3521")||c("qex")._("1427")===!0)D!=null&&x!=null?(M.push(t({externalAttachmentUrl:x,lssTraceApi:z,onGenerateOfflineMsgId:L,reply:C,s2sInstanceKey:E,stickerId:D,thread:F})),l=!1):x!=null?(M.push(r({externalAttachmentUrl:x,lssTraceApi:z,onGenerateOfflineMsgId:L,reply:C,s2sInstanceKey:E,thread:F})),l=!1):f!=null?(M.push(u({lssTraceApi:z,onGenerateOfflineMsgId:L,reply:C,s2sInstanceKey:E,thread:F,voiceClip:f})),l=!1):J.length>0?M.push(s({lssTraceApi:z,mediaStagings:J,messageTypeParams:K,onGenerateOfflineMsgId:L,reply:C,s2sInstanceKey:E,thread:F})):c("FBLogger")("messenger_web_media").mustfix("Unable to send attachment in useMAWSendSecureMessageV2Impl: incorrect params");else if(c("gkx")("2237"))M.push(q({externalAttachmentUrl:x,lssTraceApi:z,mediaStagings:J,messageTypeParams:K,onGenerateOfflineMsgId:L,reply:C,s2sInstanceKey:E,stickerId:D,thread:F,voiceClip:f}));else{y=d("MAWPrepareAttachmentsFromMediaManager").prepareAttachmentsFromMediaManager_DEPRECATED(J,K,L);M.push(p({externalAttachmentUrl:x,messageTypeParams:K,preparedAttachments:y,reply:C,s2sInstanceKey:E,stickerId:D,thread:F,voiceClip:f}))}l&&a();g(F.threadKey,!1);yield (h||(h=b("Promise"))).all(M)["catch"](function(a){d("sendToSentQPLLogger").markSendToSentFail(E,a);a instanceof Error?c("FBLogger")("messenger_web_messaging").catching(a).addMetadata("MESSENGER_E2EE_WEB","ERROR_MESSAGE","hasAttachment: "+N.toString()).mustfix("Failed while sending secure message in useMAWSendSecureMessageV2Impl"):c("FBLogger")("messenger_web_messaging").addMetadata("MESSENGER_E2EE_WEB","ERROR_MESSAGE","hasAttachment: "+N.toString()).mustfix("Failed while sending secure message in useMAWSendSecureMessageV2Impl, %s",a.message);throw a});B!=null&&B!==""&&O&&d("sendToSentQPLLogger").markSendToSentSuccess(E);yield d("WALoggerDeferred").logWithTags(["MAWSendSecureMessageV2","Composer"],["Send message is done"],"LOG");d("MAWOptimisticUpdateContactRelationship").call(F,G,e);yield w(F);H&&d("MessageRequestsLog").logActionConfirmed(F,1);I&&v(F.threadKey)});return function(a){return f.apply(this,arguments)}}(),[m,i,a,g,e,w,o,n,t,r,u,s,q,p,v])}g["default"]=a}),98);
__d("useMAWSendSecureMessageV2",["I64","MAWJids","MWPReplyContext.react","WALoggerDeferred","getMWIsDefaultHotlikeStickerId","justknobx","promiseDone","qpl","react","sendToSentQPLLogger","unrecoverableViolation","useCometInteractionTracing","useMAWSendSecureMessageV2Impl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=(h||d("react")).useContext;function a(a,b,e){var f=j(d("MWPReplyContext.react").MWPReplyContext),g=f.reply,h=c("useMAWSendSecureMessageV2Impl")(e),k=c("useCometInteractionTracing")(c("qpl")._(30605384,"573"),"fast","INTERACTION",void 0);return function(e,f,j,l,m,n,o,p,q,r,s,t,u,v,w){c("promiseDone")(d("WALoggerDeferred").logWithTags(["Composer"],["Calling useMAWSendSecureMessageV2"],"LOG"));var x=f==null?void 0:f.map(function(a){return d("MAWJids").toUserJid(a.id)}),y=e;j!=null&&c("getMWIsDefaultHotlikeStickerId")((i||(i=d("I64"))).to_string(j))&&(y="\ud83d\udc4d");var z=d("sendToSentQPLLogger").markSendToSentStart();k(function(e){c("promiseDone")(h({currentDraftId:w,externalAttachmentUrl:n,hotEmojiSize:l,lssTraceApi:e,mentionedJids:x,messageText:y,reply:g,s2sInstanceKey:z,stickerId:j,thread:a,voiceClip:p}),function(){b(),c("justknobx")._("2486")&&(r&&r())},function(a){d("sendToSentQPLLogger").markSendToSentFail(z,a);e.failTrace(a,!0);throw c("unrecoverableViolation")("Encountered failure during Armadillo Message Send (UI)","messenger_web_messaging",{error:a})})})}}g["default"]=a}),98);